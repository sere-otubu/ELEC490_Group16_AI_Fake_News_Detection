name: Continuous Integration Pipeline

on:
  push:
    branches: [ "main", "sere-backend" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Set up Python 3.13.3
      uses: actions/setup-python@v4
      with:
        python-version: "3.13.3"
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # Install Test Tools
        pip install pytest httpx
        # Install App Requirements
        pip install -r app/requirements.txt

    - name: Run Unit Tests
      run: |
        # Run pytest on the tests folder
        pytest tests/

    - name: Check HuggingFace Login
      run: |
        huggingface-cli whoami
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}

    # 8. Send Discord Notification on Success
    - name: Send Discord Notification on Success
      if: success() # Only runs if all previous steps passed
      uses: appleboy/discord-action@v1.2.0
      with:
        webhook_url: ${{ secrets.DISCORD_WEBHOOK_SECRET }}
        username: "GitHub Actions"
        avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
        color: "#48f442" # Green
        message: |
          ✅ **Backend CI Succeeded** on `${{ github.ref_name }}`
          **Committer:** ${{ github.actor }}
          See run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    # 9. Send Discord Notification on Failure
    - name: Send Discord Notification on Failure
      if: failure() # Only runs if any previous step failed
      uses: appleboy/discord-action@v1.2.0
      with:
        webhook_url: ${{ secrets.DISCORD_WEBHOOK_SECRET }}
        username: "GitHub Actions"
        avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
        color: "#FF0000" # Red
        message: |
          ❌ **Backend CI FAILED** on `${{ github.ref_name }}`
          **Committer:** ${{ github.actor }}
          See run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
